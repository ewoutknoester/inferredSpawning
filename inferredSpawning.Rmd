---
title: "Inferred spawning"
author: "Ewout Knoester"
date: "04/08/2025"
output: html_document
---

# Setup
```{r setup}

rm(list=ls()) # Clear workspace
knitr::opts_knit$set(root.dir = '/tmp') #Set directory at current directory for all subsequent chunks
options(scipen = 99) # Have all numbers in non-scientific notation

library(ggplot2)
library(grid)
library(dplyr)
library(tidyr)
library(lubridate)
library(readxl)
library(patchwork)

```

# Load data
```{r data load}

# === 1. LOAD AND CLEAN DATA ===

spawn.0raw <- as.data.frame(read_excel("Spawning database_2025-08.xlsx"))

spawn.1clean <- spawn.0raw %>%
  select(Date, Reef.type, Species, Species.description, Eggs, Comments) %>%
  filter(Eggs %in% c("No", "Immature", "Mature")) %>%
  filter(!is.na(Species), !is.na(Eggs), !is.na(Date))

spawn.2sum <- spawn.1clean %>%
  mutate(
    Date = as.Date(Date),
    Year = year(Date),
    Species = as.character(Species),
    Eggs = factor(Eggs, levels = c("No", "Immature", "Mature")),
    DayOfYear = yday(Date),
    x_numeric = DayOfYear
  )

# === 2. SUMMARISE BY ACTUAL DATE ===

spawn.3pie <- spawn.2sum %>%
  group_by(Species, Year, Date, Eggs, x_numeric) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Species, Year, Date, x_numeric) %>%
  complete(Eggs = factor(c("No", "Immature", "Mature"),
                         levels = c("No", "Immature", "Mature")),
           fill = list(n = 0)) %>%
  mutate(frac = n / sum(n)) %>%
  ungroup()

# === 3. Y-AXIS POSITIONS ===

y_order <- spawn.3pie %>%
  distinct(Species, Year) %>%
  arrange(Species, Year) %>%
  mutate(Ypos = row_number())

spawn.3pie <- spawn.3pie %>%
  left_join(y_order, by = c("Species", "Year"))

# === 4. BASE PLOT ===

dummy_points <- y_order %>% mutate(x = 0)

plot_base <- ggplot() +
  geom_point(data = dummy_points, aes(x = x, y = Ypos), alpha = 0) +
  scale_x_continuous(
    name = "Month",
    breaks = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335),
    labels = month.abb,
    expand = expansion(add = 5)
  ) +
  scale_y_continuous(
    breaks = y_order$Ypos,
    labels = paste(y_order$Species, y_order$Year, sep = " - "),
    name = "Species",
    expand = expansion(add = 1)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

# === 5. PIE CHART FUNCTION ===

make_pie_grob <- function(df_group, show_legend = FALSE) {
  ggplot(df_group, aes(x = "", y = frac, fill = Eggs)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    scale_fill_manual(
      values = c("gray70", "orange", "red"),
      name = "Egg status"
    ) +
    theme_void() +
    theme(legend.position = if (show_legend) "right" else "none")
}

# === 6. DRAW PIE CHARTS ===

group_ids <- spawn.3pie %>%
  group_by(Species, Year, Date) %>%
  filter(n() == 3) %>%
  ungroup() %>%
  distinct(Species, Year, Date, x_numeric)

for (i in seq_len(nrow(group_ids))) {
  group_data <- spawn.3pie %>%
    filter(Species == group_ids$Species[i],
           Year == group_ids$Year[i],
           Date == group_ids$Date[i])
  
  if (nrow(group_data) == 3) {
    grob <- ggplotGrob(make_pie_grob(group_data))
    xpos <- group_data$x_numeric[1]
    ypos <- group_data$Ypos[1]
    
    plot_base <- plot_base +
      annotation_custom(
        grob,
        xmin = xpos - 5, xmax = xpos + 5,
        ymin = ypos - 0.4, ymax = ypos + 0.4
      )
  }
}

# === 7. FULL MOON ICONS ===

full_moons <- tibble(
  Date = as.Date(c(
    "2022-01-17", "2022-02-16", "2022-03-18", "2022-04-16",
    "2022-05-16", "2022-06-14", "2022-07-13", "2022-08-11",
    "2022-09-10", "2022-10-09", "2022-11-08", "2022-12-08"
  )),
  Label = "ðŸŒ•"
) %>%
  mutate(x_numeric = yday(Date))

plot_base <- plot_base +
  geom_text(
    data = full_moons,
    aes(x = x_numeric, y = min(y_order$Ypos) - 1, label = Label),
    size = 5
  )

# === 8. LEGEND PLOT ===

legend_data <- tibble(
  Eggs = factor(c("No", "Immature", "Mature"),
                levels = c("No", "Immature", "Mature")),
  frac = c(1, 1, 1) / 3
)

legend_plot <- make_pie_grob(legend_data, show_legend = TRUE)

# === 9. COMBINE AND SAVE ===

combined_plot <- plot_base + legend_plot + plot_layout(widths = c(5, 1))

print(combined_plot)

ggsave("inferredSpawning_Species x Date x Year x Eggs_withLegend.tiff",
       plot = combined_plot,
       width = 35, height = 21, units = "cm", dpi = 600, compression = "lzw")





```

