---
title: "Inferred spawning"
author: "Ewout Knoester"
date: "04/08/2025"
output: html_document
---

# Setup
```{r setup}

rm(list=ls()) # Clear workspace
knitr::opts_knit$set(root.dir = '/tmp') #Set directory at current directory for all subsequent chunks
options(scipen = 99) # Have all numbers in non-scientific notation

library(ggplot2)
library(grid)
library(dplyr)
library(tidyr)
library(lubridate)
library(readxl)
library(patchwork)
library(scales)

```

# Load data
```{r data load}

# === 1. LOAD AND CLEAN DATA ===

spawn.0raw <- as.data.frame(read_excel("Spawning database_2025-08.xlsx"))

spawn.1clean <- spawn.0raw %>%
  select(Date, Reef.type, Species, Species.description, Eggs, Comments) %>%
  filter(Eggs %in% c("No", "Immature", "Mature")) %>%
  filter(!is.na(Species), !is.na(Eggs), !is.na(Date))

spawn.2sum <- spawn.1clean %>%
  mutate(
    Date = as.Date(Date),
    Month = month(Date),
    Year = year(Date),
    Species = as.character(Species),
    Eggs = factor(Eggs, levels = c("No", "Immature", "Mature")),
    SeasonStartRaw = ifelse(Month >= 7, Year, Year - 1),
    SeasonStart = ifelse(SeasonStartRaw == 2022, 2023, SeasonStartRaw),
    SeasonLabel = paste0(SeasonStart, "â€“", SeasonStart + 1),
    DayOfSeason = as.integer(Date - as.Date(paste0(SeasonStartRaw, "-07-01"))) + 1,
    x_numeric = DayOfSeason
  )

# === 2. SUMMARISE BY SEASON-DATE ===

spawn.3pie <- spawn.2sum %>%
  group_by(Species, SeasonLabel, Date, Eggs, x_numeric) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Species, SeasonLabel, Date, x_numeric) %>%
  complete(Eggs = factor(c("No", "Immature", "Mature"),
                         levels = c("No", "Immature", "Mature")),
           fill = list(n = 0)) %>%
  mutate(frac = n / sum(n)) %>%
  group_by(Species, SeasonLabel, Date) %>%
  mutate(n_total = sum(n)) %>%
  ungroup()

# === 3. Y-AXIS POSITIONS ===

y_order <- spawn.3pie %>%
  distinct(Species, SeasonLabel) %>%
  arrange(Species, SeasonLabel) %>%
  mutate(Ypos = row_number())

spawn.3pie <- spawn.3pie %>%
  left_join(y_order, by = c("Species", "SeasonLabel"))

# === 4. BASE PLOT ===

dummy_points <- y_order %>% mutate(x = 0)

month_starts <- seq(as.Date("2000-07-01"), as.Date("2001-06-01"), by = "1 month")
month_days <- as.integer(month_starts - as.Date("2000-07-01")) + 1
month_labels <- format(month_starts, "%b")

plot_base <- ggplot() +
  geom_point(data = dummy_points, aes(x = x, y = Ypos), alpha = 0) +
scale_x_continuous(
  name = "Month",
  breaks = month_days,
  labels = month_labels,
  limits = c(0, 370),  # full range for July 1 to June 30 (up to leap year safety)
  expand = c(0, 0)
)+
  scale_y_continuous(
    breaks = y_order$Ypos,
    labels = paste(y_order$Species, y_order$SeasonLabel, sep = " - "),
    name = "Species",
    expand = expansion(add = 10)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

# === 5. PIE CHART FUNCTION ===

make_pie_grob <- function(df_group, show_legend = FALSE) {
  ggplot(df_group, aes(x = "", y = frac, fill = Eggs)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    scale_fill_manual(
      values = c("gray70", "orange", "red"),
      name = "Egg status"
    ) +
    theme_void() +
    theme(legend.position = if (show_legend) "right" else "none")
}

radius_scale <- function(n) {
  rescale(n, to = c(2, 7), from = range(spawn.3pie$n_total, na.rm = TRUE))
}

# === 6. DRAW PIE CHARTS ===

group_ids <- spawn.3pie %>%
  group_by(Species, SeasonLabel, Date) %>%
  summarise(n_rows = n(), x_numeric = first(x_numeric), Ypos = first(Ypos),
            n_total = first(n_total), .groups = "drop") %>%
  filter(n_rows == 3)

# Collect grobs
pie_grobs <- vector("list", length = nrow(group_ids))

for (i in seq_len(nrow(group_ids))) {
  group_data <- spawn.3pie %>%
    filter(Species == group_ids$Species[i],
           SeasonLabel == group_ids$SeasonLabel[i],
           Date == group_ids$Date[i])

  grob <- ggplotGrob(make_pie_grob(group_data))
  xpos <- group_ids$x_numeric[i]
  ypos <- group_ids$Ypos[i]
  radius <- radius_scale(group_ids$n_total[i])

  pie_grobs[[i]] <- annotation_custom(
    grob,
    xmin = xpos - radius, xmax = xpos + radius,
    ymin = ypos - radius * 0.1, ymax = ypos + radius * 0.1
  )
}

# Add grobs to plot
for (grob_obj in pie_grobs) {
  plot_base <- plot_base + grob_obj
}


# === 7. LEGENDS ===

legend_data <- tibble(
  Eggs = factor(c("No", "Immature", "Mature"),
                levels = c("No", "Immature", "Mature")),
  frac = c(1/3, 1/3, 1/3)
)

egg_legend <- ggplot(legend_data, aes(x = "", y = frac, fill = Eggs)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  scale_fill_manual(values = c("gray70", "orange", "red"), name = "Egg status") +
  theme_void() +
  theme(legend.position = "right")

n_range <- range(spawn.3pie$n_total, na.rm = TRUE)
n_small <- n_range[1]
n_large <- n_range[2]

make_scaled_pie_grob <- function(n_val) {
  df <- tibble(
    Eggs = factor(c("No", "Immature", "Mature"), levels = c("No", "Immature", "Mature")),
    frac = c(1/3, 1/3, 1/3),
    n_total = n_val
  )
  ggplotGrob(make_pie_grob(df))
}

grob_small <- make_scaled_pie_grob(n_small)
grob_large <- make_scaled_pie_grob(n_large)

size_legend_base <- ggplot() +
  xlim(0, 20) + ylim(0, 20) +
  theme_void() +
  annotate("text", x = 10, y = 19, label = "Sampling effort", size = 4)

r_small <- radius_scale(n_small)
r_large <- radius_scale(n_large)

size_legend_base <- size_legend_base +
  annotation_custom(grob_large,
                    xmin = 9 - r_large, xmax = 9 + r_large,
                    ymin = 15 - r_large * 0.1, ymax = 15 + r_large * 0.1) +
  annotate("text", x = 11 + r_large, y = 15, label = paste0("n = ", n_large), hjust = 0, size = 3) +
  annotation_custom(grob_small,
                    xmin = 9 - r_small, xmax = 9 + r_small,
                    ymin = 11 - r_small * 0.1, ymax = 11 + r_small * 0.1) +
  annotate("text", x = 11 + r_small, y = 11, label = paste0("n = ", n_small), hjust = 0, size = 3)

legend_stack <- egg_legend / size_legend_base +
  plot_layout(heights = c(1, 1.5))

# === 8. COMBINE AND SAVE ===

combined_plot <- plot_base + legend_stack + plot_layout(widths = c(5, 1.5))

print(combined_plot)

ggsave("inferredSpawning_Species x Season x Eggs_scaledBySample_legendRight.tiff",
       plot = combined_plot,
       width = 35, height = 21, units = "cm", dpi = 600, compression = "lzw")

ggsave("debug_plot.png", plot = plot_base, width = 10, height = 10)

```



